<div class="container-fluid ms-5 mt-4">
  <div class="row">
    <div class="col-11 col-xl-8">
      <div class="row">
        <h2>Mis Reservas</h2>
        <!-- Mostrar error si fallan ambos servicios -->
        <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
          <strong>Error:</strong> {{ errorMessage }}
          <div class="mt-2">
            <a href="#" class="error-link" (click)="reloadReservas(); $event.preventDefault()">
              Intentalo de nuevo
            </a>
          </div>
        </div>
        <div *ngIf="!errorMessage && reservas.length === 0" class="card p-4">
          No tienes reservas realizadas.
        </div>
      </div>

      <div class="row mt-5" *ngIf="reservas.length > 0">
        <table class="table">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Fecha inicio</th>
              <th scope="col">Fecha término</th>
              <th scope="col">Nro Casillero</th>
              <th scope="col">Estado</th>
              <th scope="col">Acción</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let reserva of reservas; let i = index">
              <th scope="row">{{ i + 1 }}</th>
              <td>{{ reserva.fecha_inicio | date : "short" }}</td>
              <td>{{ reserva.fecha_vencimiento | date : "short" }}</td>
              <td>{{ reserva.id_cld }}</td>
              <td>{{ reserva.estado | uppercase }}</td>
              <td>
                <button
                  *ngIf="reserva.estado === 'activa'"
                  class="btn btn-danger btn-sm"
                  (click)="openConfirmLiberar(reserva)"
                  [disabled]="loadingLiberar[reserva.id_rsv]"
                >
                  <span *ngIf="!loadingLiberar[reserva.id_rsv]">Liberar</span>
                  <span *ngIf="loadingLiberar[reserva.id_rsv]"
                    >Liberando...</span
                  >
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="col-12 col-xl-3 ms-lg-5 ms-md-0 mt-md-5">
      <div class="card mb-3" style="max-width: 600px">
        <div class="row g-0">
          <div class="col-md-4">
            <img
              src="assets/images/informatica.jpg"
              class="img-fluid rounded-start w-100 h-100 object-fit-cover"
              alt="Ubicación informática UTA"
            />
          </div>
          <div class="col-md-8">
            <div class="card-body">
              <h5 class="card-title fw-bold">Ubicación</h5>
              <p class="card-text">informatica UTA</p>
              <p>
                Alcalde Edmundo Flores 301-399, 1010399 Arica, Arica y
                Parinacota
              </p>
            </div>
          </div>

          <!-- Modal de confirmación para liberar reserva -->
          <ng-template #confirmLiberar let-modal>
            <div class="modal-header">
              <h5 class="modal-title">Confirmar liberación</h5>
              <button
                type="button"
                class="btn-close"
                aria-label="Close"
                (click)="cancelarLiberar(modal)"
              ></button>
            </div>
            <div class="modal-body">
              <p>
                ¿Estás seguro que deseas liberar este casillero? La reserva será
                cancelada y el casillero quedará disponible.
              </p>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="cancelarLiberar(modal)"
              >
                Cancelar
              </button>
              <button
                type="button"
                class="btn btn-danger"
                (click)="confirmarLiberar(modal)"
              >
                Confirmar liberación
              </button>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
